<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Protocolo de Documentos EMEC</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        :root {
            --bs-primary: #4CAF50;
            --bs-body-bg: #F8F9FA;
        }
        body { background-color: var(--bs-body-bg); }
        .file-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background-color: #fff;
            cursor: pointer;
        }
        .file-input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    </style> 
</head>
<body>
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10 col-xl-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white text-center p-4">
                        <h1 class="card-title h4 mb-0">Protocolo de Documentos</h1>
                    </div>
                    <div class="card-body p-4 p-md-5">
                        <div class="text-center mb-4">
                            <img src="grupoemec.png" alt="Logo" style="height: 50px;">
                        </div>
                        <div id="successAlert" class="alert alert-success d-none"><span id="successMessage"></span></div>
                        <div id="errorAlert" class="alert alert-danger d-none"><span id="errorMessage"></span></div>

                        <form id="documentForm" action="https://automacoes-n8n.sgmdos.easypanel.host/webhook/protocolov2" method="POST" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Tipo de Documento <span class="text-danger">*</span></label>
                                <select class="form-select" id="documentType" name="documentType" required>
                                    <option value="" disabled selected>Selecione...</option>
                                    <option value="ADMISSIONAIS">Admissionais</option>
                                    <option value="ATESTADOS">Atestados</option>
                                    <option value="OUTROS">Outros</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="employeeSearch" class="form-label fw-semibold">Busca (filtro por CAD ou Nome)</label>
                                <input type="text" class="form-control" id="employeeSearch" placeholder="Digite para buscar..." list="employee-list">
                                <datalist id="employee-list"></datalist>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-semibold">CAD <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="employeeCAD" name="employeeCAD" readonly required>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-semibold">Nome Completo <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="employeeName" name="employeeName" readonly required>
                                </div>
                            </div>
                            <input type="hidden" id="employeeNumemp" name="employeeNumemp">

                            <div class="mb-4">
                                <label class="form-label fw-semibold">Setor <span class="text-danger">*</span></label>
                                <select class="form-select" id="sector" name="sector" required>
                                    <option value="" disabled selected>Selecione o setor...</option>
                                    <option value="ADM CENTRAL">ADM CENTRAL</option>
                                    <option value="PM SERRA">PM SERRA</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-semibold"><i class="bi bi-paperclip me-1"></i> Anexar Arquivos</label>
                                <div class="file-upload-area" id="fileUploadArea">
                                    <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                                    <p class="fw-bold">Clique ou arraste arquivos aqui</p>
                                    <input type="file" class="file-input" id="fileUpload" multiple accept=".pdf,.doc,.docx,.jpg,.png">
                                </div>
                                <div id="fileList" class="mt-2"></div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-semibold">Observações <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="observations" name="observations" rows="4" required minlength="3"></textarea>
                                <small id="charCounter" class="text-muted">0/500</small>
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">Enviar Documentos</button>
                                <button type="button" class="btn btn-secondary btn-lg" id="clearBtn">Limpar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // ... (Seu script de validação e upload continua aqui igual ao original) ...
        // Vou focar na parte da BUSCA que você quer corrigir:

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('employeeSearch');
            const cadInput = document.getElementById('employeeCAD');
            const nameInput = document.getElementById('employeeName');
            const numempInput = document.getElementById('employeeNumemp');
            const employeeList = document.getElementById('employee-list');

            searchInput.addEventListener('input', async (e) => {
                const currentValue = e.target.value;
                const selectedOption = Array.from(employeeList.options).find(opt => opt.value === currentValue);

                if (selectedOption) {
                    cadInput.value = selectedOption.dataset.cad;
                    nameInput.value = selectedOption.dataset.name;
                    numempInput.value = selectedOption.dataset.numemp;
                    searchInput.value = '';
                    return;
                }

                if (currentValue.length < 1) return;

                try {
                    const response = await fetch(`/search-employees?term=${encodeURIComponent(currentValue)}`);
                    if (!response.ok) return; // Evita erro se o servidor der 500
                    
                    const employees = await response.json();
                    employeeList.innerHTML = '';
                    
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        // Formato solicitado: Empresa - Cadastro - Nome
                        option.value = `${emp.numemp} - ${emp.numcad} - ${emp.nomfun}`;
                        option.dataset.cad = emp.numcad;
                        option.dataset.name = emp.nomfun;
                        option.dataset.numemp = emp.numemp;
                        employeeList.appendChild(option);
                    });
                } catch (err) { console.error(err); }
            });
        });
    </script>
</body>
</html>
